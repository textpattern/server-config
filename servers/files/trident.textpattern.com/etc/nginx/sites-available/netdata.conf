# start `netdata` server block at `/etc/nginx/sites-available/netdata.conf` (created: 2018-11-29 13:46:58)
upstream netdata-backend {
	keepalive 60;
	server 127.0.0.1:19999;
}

server {#netdata hostname, https
	access_log /var/log/nginx/netdata@trident.textpattern.com.access.log ipscrubbed;
	#nested variable for Content Security Policy maintainability
	set $contentsecuritypolicy_https_netdata '';
	set $contentsecuritypolicy_https_netdata '${contentsecuritypolicy_https_netdata}connect-src \'self\' https://api.github.com https://registry.my-netdata.io;';
	set $contentsecuritypolicy_https_netdata '${contentsecuritypolicy_https_netdata}default-src \'none\';';
	set $contentsecuritypolicy_https_netdata '${contentsecuritypolicy_https_netdata}font-src \'self\';';
	set $contentsecuritypolicy_https_netdata '${contentsecuritypolicy_https_netdata}frame-ancestors \'none\';';
	set $contentsecuritypolicy_https_netdata '${contentsecuritypolicy_https_netdata}img-src \'self\' data:;';
	set $contentsecuritypolicy_https_netdata '${contentsecuritypolicy_https_netdata}manifest-src \'self\';';
	set $contentsecuritypolicy_https_netdata '${contentsecuritypolicy_https_netdata}media-src \'self\';';
	set $contentsecuritypolicy_https_netdata '${contentsecuritypolicy_https_netdata}object-src \'self\';';
	set $contentsecuritypolicy_https_netdata '${contentsecuritypolicy_https_netdata}script-src \'self\' \'unsafe-inline\';';
	set $contentsecuritypolicy_https_netdata '${contentsecuritypolicy_https_netdata}style-src \'self\' \'unsafe-inline\';';
	set $contentsecuritypolicy_https_netdata '${contentsecuritypolicy_https_netdata}worker-src \'self\';';
	add_header Content-Security-Policy $contentsecuritypolicy_https_netdata;
	#nested variable for Feature Policy maintainability
	set $featurepolicy_https_netdata '';
	set $featurepolicy_https_netdata '${featurepolicy_https_netdata}camera \'none\';';
	set $featurepolicy_https_netdata '${featurepolicy_https_netdata}fullscreen \'self\';';
	set $featurepolicy_https_netdata '${featurepolicy_https_netdata}geolocation \'none\';';
	set $featurepolicy_https_netdata '${featurepolicy_https_netdata}gyroscope \'none\';';
	set $featurepolicy_https_netdata '${featurepolicy_https_netdata}magnetometer \'none\';';
	set $featurepolicy_https_netdata '${featurepolicy_https_netdata}microphone \'none\';';
	set $featurepolicy_https_netdata '${featurepolicy_https_netdata}midi \'none\';';
	set $featurepolicy_https_netdata '${featurepolicy_https_netdata}notifications \'self\';';
	set $featurepolicy_https_netdata '${featurepolicy_https_netdata}payment \'none\';';
	set $featurepolicy_https_netdata '${featurepolicy_https_netdata}push \'self\';';
	set $featurepolicy_https_netdata '${featurepolicy_https_netdata}speaker \'none\';';
	set $featurepolicy_https_netdata '${featurepolicy_https_netdata}sync-xhr \'self\';';
	set $featurepolicy_https_netdata '${featurepolicy_https_netdata}vibrate \'none\''; #no trailing semicolon
	add_header Feature-Policy $featurepolicy_https_netdata;
	add_header Referrer-Policy strict-origin;
	add_header Strict-Transport-Security "max-age=15768000; includeSubDomains; preload";
	add_header X-Content-Type-Options nosniff;
	add_header X-Frame-Options DENY;
	add_header X-XSS-Protection "1; mode=block";
	error_log /var/log/nginx/netdata@trident.textpattern.com.error.log error;
	listen [::]:909 http2 ssl;
	listen 909 http2 ssl;
	server_name trident.textpattern.com;
	ssl_certificate /etc/letsencrypt/live/trident.textpattern.com/fullchain.pem;
	ssl_certificate_key /etc/letsencrypt/live/trident.textpattern.com/privkey.pem;
	ssl_trusted_certificate /etc/letsencrypt/live/trident.textpattern.com/fullchain.pem;
	location / {
		limit_except GET HEAD POST {
			deny all;
		}
		auth_basic "Authentication";
		auth_basic_user_file /etc/nginx/.htpasswd;
		proxy_http_version 1.1;
		proxy_pass http://netdata-backend;
		proxy_pass_request_headers on;
		proxy_set_header Connection "keep-alive";
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Host $host;
		proxy_set_header X-Forwarded-Server $host;
		proxy_store off;
	}
	location = /favicon.ico {
		log_not_found off;
	}
}
# end `netdata` server block

