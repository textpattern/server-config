#server block for www.textpattern.com (v20180902)
map $sent_http_content_type $www_textpattern_com_expires {
default 1M;
application/atom+xml 1h;
application/javascript 1M;
application/json 0s;
application/ld+json 0s;
application/manifest+json 1w;
application/rdf+xml 1h;
application/rss+xml 1h;
application/schema+json 0s;
application/x-javascript 1M;
application/xml 0s;
font/woff 1M;
image/gif 1M;
image/jpeg 1M;
image/png 1M;
image/svg+xml 1M;
image/vnd.microsoft.icon 1M;
image/webp 1M;
image/x-icon 1M;
text/cache-manifest 0s;
text/css 1M;
text/html 0s;
text/javascript 1M;
text/x-cross-domain-policy 1w;
text/xml 0s;
video/mp4 1M;
video/webm 1M;
}
server {#IPv4 and IPv6, http, redirect to https on bare domain
	access_log /var/log/nginx/www.textpattern.com.access.log ipscrubbed;
	error_log /var/log/nginx/www.textpattern.com.error.log crit;
	index index.html index.php;
	listen [::]:80;
	listen 80;
	return 301 https://textpattern.com$request_uri;
	root /var/www/vhosts/textpattern.com/www/live;
	server_name www.textpattern.com textpattern.com;
	location ^~ /.well-known/ {
		allow all;
		default_type "text/plain";
		root /var/www/vhosts/textpattern.com/www/;
	}
	location / {
		limit_except GET POST {
			deny all;
		}
		try_files $uri $uri/ /index.php?$args;
	}
	location = /favicon.ico {
		log_not_found off;
	}
	location ~ /\. {
		deny all;
	}
	location ~ ^.+\.php(?:/.*)?$ {
		fastcgi_hide_header "X-Powered-By";
		fastcgi_index index.php;
		fastcgi_keep_conn on;
		fastcgi_next_upstream error timeout;
		fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
		fastcgi_pass unix:/var/run/php/php7.2-fpm.sock;
		fastcgi_split_path_info ^(.+\.php)(/.+)$;
		include fastcgi_params;
		try_files $uri =404;
	}
}

server {#IPv4 and IPv6, https, redirect https://www.textpattern.com to https://textpattern.com
        listen [::]:443 http2 ssl;
        listen 443 http2 ssl;
	server_name www.textpattern.com;
        ssl_certificate /etc/letsencrypt/live/www.textpattern.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/www.textpattern.com/privkey.pem;
        ssl_trusted_certificate /etc/letsencrypt/live/www.textpattern.com/fullchain.pem;
	return 301 https://textpattern.com$request_uri;
}

server {#IPv4 and IPv6, https, PHP fastcgi, check https://cipherli.st for latest ciphers
	access_log /var/log/nginx/www.textpattern.com.access.log ipscrubbed;
	add_header Access-Control-Allow-Origin "https://*.textpattern.io";
	add_header Content-Security-Policy "default-src 'self'; connect-src 'self' https://api.github.com; font-src 'self'; img-src 'self' data: * https://*; media-src 'self' * https://*; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' https://cdn.ampproject.org";
	add_header Expect-CT "max-age=0; report-uri=https://textpattern.io/expect-ct-report";
	add_header Feature-Policy "camera 'self'; geolocation 'none'; microphone 'none'; midi 'none'; payment 'none'";
	add_header Referrer-Policy strict-origin;
	add_header Strict-Transport-Security "max-age=15768000; includeSubDomains; preload";
	add_header X-Content-Type-Options nosniff;
	add_header X-Frame-Options DENY;
	add_header X-XSS-Protection "1; mode=block";
	charset_types
		application/atom+xml
		application/javascript
		application/json
		application/ld+json
		application/manifest+json
		application/rdf+xml
		application/rss+xml
		application/xml
		text/cache-manifest
		text/css
	;
	error_log /var/log/nginx/www.textpattern.com.error.log crit;
	etag off;
	#expires $www_textpattern_com_expires;
	index index.html index.php;
	listen [::]:443 http2 ssl;
	listen 443 http2 ssl;
	root /var/www/vhosts/textpattern.com/www/live;
	server_name textpattern.com;
	ssl_certificate /etc/letsencrypt/live/www.textpattern.com/fullchain.pem;
	ssl_certificate_key /etc/letsencrypt/live/www.textpattern.com/privkey.pem;
	ssl_trusted_certificate /etc/letsencrypt/live/www.textpattern.com/fullchain.pem;
	location ^~ /.well-known/ {
		allow all;
		default_type "text/plain";
		root /var/www/vhosts/textpattern.com/www/;
	}
	location / {
		limit_except GET POST {
			deny all;
		}
		rewrite "^(.*?)\.[0-9]+\.(css|js|svg)$" "$1.$2";
		rewrite ^/plugins/txp_plugin_template.txt$ https://github.com/textpattern/textpattern-plugin-template permanent;
		rewrite ^/forum$$ https://forum.textpattern.io permanent;
		rewrite ^/@textpattern$ https://twitter.com/textpattern redirect;
		rewrite ^/\+$ https://plus.google.com/+textpattern redirect;
		rewrite ^/github$ https://github.com/textpattern redirect;
		rewrite ^/demo$ https://textpattern.co/demo redirect;
		rewrite ^/textpattern-first-steps$ https://docs.textpattern.io/faqs/textpattern-basic-tutorial redirect;
		rewrite ^/textpattern-semantic-model$ https://docs.textpattern.io/faqs/textpattern-semantic-model redirect;
		rewrite ^/textpattern-tag-reference$ https://docs.textpattern.io/tags redirect;
		rewrite ^/hidden-files-osx$ https://docs.textpattern.io/installation/view-hidden-files-on-macos redirect;
		rewrite ^/default-theme$ https://github.com/textpattern/textpattern-default-theme redirect;
		rewrite ^/languages$ https://textpattern.com/about/301/languages redirect;
		rewrite ^/textpacks-download$ https://github.com/textpattern/textpacks/releases/download/4.7.1/textpacks.zip redirect;
		rewrite ^/textile-changelog$ https://github.com/textile/php-textile/blob/master/CHANGELOG.textile redirect;
		rewrite ^/textile-sandbox$ https://txstyle.org/article/43/a-short-introduction redirect;
		rewrite ^/textile-reference-manual$ https://txstyle.org redirect;
		rewrite ^/textile-abbr$ https://txstyle.org/doc/32/acronyms redirect;
		rewrite ^/textile-blockquote$ https://txstyle.org/doc/3/block-quotations redirect;
		rewrite ^/textile-cite$ https://txstyle.org/doc/20/citation redirect;
		rewrite ^/textile-dl-list$ https://txstyle.org/doc/10/definition-lists redirect;
		rewrite ^/textile-em-and-i$ https://txstyle.org/doc/17/emphasized-and-italic-text redirect;
		rewrite ^/textile-footnote$ https://txstyle.org/doc/11/footnotes redirect;
		rewrite ^/textile-heading$ https://txstyle.org/doc/7/headings redirect;
		rewrite ^/textile-image$ https://txstyle.org/doc/14/images redirect;
		rewrite ^/textile-ins-and-del$ https://txstyle.org/doc/19/insertions-and-deletions redirect;
		rewrite ^/textile-link$ https://txstyle.org/doc/12/links redirect;
		rewrite ^/textile-ol-list$ https://txstyle.org/doc/9/numbered-lists redirect;
		rewrite ^/textile-span$ https://txstyle.org/doc/33/span redirect;
		rewrite ^/textile-strong-and-b$ https://txstyle.org/doc/16/strong-and-bold-text redirect;
		rewrite ^/textile-sub-and-sup$ https://txstyle.org/doc/18/subscript-and-superscript-text redirect;
		rewrite ^/textile-table$ https://txstyle.org/doc/15/tables redirect;
		rewrite ^/textile-ul-list$ https://txstyle.org/doc/8/bullet-list redirect;
		rewrite ^/donate$ https://textpattern.com/about/302/patrons permanent;
		rewrite ^/download$ https://textpattern.com/start permanent;
		rewrite ^/download-beta$ https://textpattern.com/start permanent;
		rewrite ^/featured$ https://textpattern.com/showcase permanent;
		rewrite ^/documentation$ https://docs.textpattern.io permanent;
		rewrite ^/features$ https://textpattern.com/about/338/textpattern-features permanent;
		rewrite ^/system-requirements$ https://textpattern.com/about/119/system-requirements permanent;
		rewrite ^/support$ https://textpattern.com/about/345/community-support permanent;
		rewrite ^/features/301/languages$ https://textpattern.com/about/301/languages permanent;
		rewrite ^/contributors$ https://textpattern.com/about/219/contributors permanent;
		rewrite ^/patrons$ https://textpattern.com/about/302/patrons permanent;
		rewrite ^/hosting$ https://textpattern.com/about/363/web-hosting permanent;
		rewrite ^/security$ https://textpattern.com/contact#security permanent;
		rewrite ^/releases$ https://textpattern.com/category/releases permanent;
		rewrite ^/faq.*$ https://docs.textpattern.io permanent;
		rewrite ^/themes$ https://docs.textpattern.io/themes/ redirect;
		rewrite ^/plugins$ http://textpattern.org/ redirect;
		try_files $uri $uri/ /index.php?$args;
	}
	location = /favicon.ico {
		log_not_found off;
	}
	location ~ /\. {
		deny all;
	}
	location ~* \.(eot|ttf|woff)$ {
		add_header Access-Control-Allow-Origin "https://textpattern.io";
		expires 1M;
	}
	location ~ ^.+\.php(?:/.*)?$ {
		fastcgi_hide_header "X-Powered-By";
		fastcgi_index index.php;
		fastcgi_keep_conn on;
		fastcgi_next_upstream error timeout;
		fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
		fastcgi_pass unix:/var/run/php/php7.2-fpm.sock;
		fastcgi_split_path_info ^(.+\.php)(/.+)$;
		include fastcgi_params;
		try_files $uri =404;
	}
}
#end www.textpattern.com server block

